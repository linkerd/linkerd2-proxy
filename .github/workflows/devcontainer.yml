name: devcontainer

# When a pull request is opened that changes the Devcontainer configuration,
# ensure that the container continues to build properly.
on:
  pull_request:
    paths:
      - rust-toolchain
      - .devcontainer/**

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b
      - run: docker build .devcontainer

  devcontainer-image:
    runs-on: ubuntu-latest
    container: ghcr.io/linkerd/dev:v21-tools
    steps:
      - uses: actions/checkout@2541b1294d2704b0964813337f33b291d3f8596b
      - run: |
          # Strip out comments from the devcontainer.json for jq.
          VERSION="$(grep -Ev '^\s*//.*' .devcontainer/devcontainer.json |jq -r '.image | split(":")[1]')"
          ex=0
          while IFS= read -r file ; do
            while IFS= read -r image ; do
              if [[ "$image" =~ ^docker://ghcr.io/linkerd/dev: ]]; then
                tag="${image##*dev:}"
                tag="${tag%-*}"
                if [ "$tag" != "$VERSION" ]; then
                  echo "::warning file=$file::$file uses incorrect devcontainer version: $tag is not $VERSION"
                  ex=$((ex + 1))
                fi
              fi
            done < <(yq '.jobs[] | select(.container) | .container.image // .container' "$file")
          done < <(find .github/workflows -maxdepth 1 -type f -name '*.yml')
          exit $ex
