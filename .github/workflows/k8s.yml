name: k8s

permissions:
  contents: read

on:
  pull_request:
    paths:
      - Cargo.lock
      - Dockerfile
      - "**/*.rs"
      - "**/*.toml"
      - justfile
      - .github/workflows/k8s.yml

# Run only the app-level tests. These may take longer to compile (usually due to very large stack
# types) and have the potential to be flakey as they depend on opening sockets and may have timing
# sensitivity.
jobs:
  linkerd-install:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - uses: linkerd/dev/actions/setup-tools@v39
      - name: Install linkerd CLI (edge)
        id: linkerd
        run: |
          scurl https://run.linkerd.io/install-edge | sh
          echo "PATH=$PATH:$HOME/.linkerd2/bin" >> "$GITHUB_ENV"
          export PATH="$PATH:$HOME/.linkerd2/bin"
          echo "tag=$(linkerd version --client --short)" >> "$GITHUB_OUTPUT"

      - uses: actions/checkout@ac593985615ec2ede58e132d2e21d2b1cbd6127c
      - uses: actions/cache@9b0c1fce7a93df8e3bb8926b0d6e9d89e92f20a7
        with:
          path: ${{ runner.temp }}/buildx
          key: buildx-${{ runner.os }}-${{ steps.linkerd.outputs.tag }}-${{ github.sha }}
          restore-keys: buildx-${{ runner.os }}-${{ steps.linkerd.outputs.tag }}-

      - run: just docker
        env:
          DOCKER_BUILDX_CACHE_DIR: '${{ runner.temp }}/buildx'

      - run: just-k3d create
      - run: just 'linkerd-tag=${{ steps.linkerd.outputs.tag }}' linkerd-load
      - run: just 'linkerd-tag=${{ steps.linkerd.outputs.tag }}' linkerd-install
      - name: Run linkerd check
        run: |
          linkerd check -o json > '${{ runner.temp }}/check.json'
          result=$(jq -r \
            '.categories[] | select(.categoryName == "linkerd-control-plane-proxy") | .checks[] | select(.description == "control plane proxies are healthy") | .result' \
            '${{ runner.temp }}/check.json')
          if [ "$result" != "success" ]; then
            jq '.categories[] | .checks[] | select(.result != "success") | select(.hint | contains("-version") | not)' \
                '${{ runner.temp }}/check.json' >&2
            just-k3d kubectl describe po -n linkerd >&2
            exit 1
          fi
