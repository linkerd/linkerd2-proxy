version: "3.7"
services:
  iperf:
    build:
      context: .
      dockerfile: Dockerfile-iperf
    command: ["iperf", "-s", "-p 5001"]

  proxy:
    build:
      context: ..
      dockerfile: profiling/Dockerfile-proxy
    environment:
      SERVER:
      SERVER_PORT:
      LINKERD2_PROXY_LOG: "${LINKERD2_PROXY_LOG}"
      PROXY_PERF:
      NAME:
    command: /usr/bin/run-proxy
    depends_on:
      - iperf
      - fortio
    security_opt:
      - seccomp:./seccomp-perf.json
    volumes:
      - type: bind
        source: "${OUT_DIR}"
        target: "/out"
    secrets:
      - source: proxy_key
        target: /root/.ssh/id_ecdsa

  fortio:
    build:
      context: .
      dockerfile: Dockerfile-fortio
    volumes:
      - type: bind
        source: "${OUT_DIR}"
        target: "/out"
    secrets:
      - source: authorized_keys
        target: /root/.ssh/authorized_keys
        # mode: 600

secrets:
  authorized_keys:
    file: "${TEST_KEY_DIR}/authorized_keys"
  proxy_key:
    file: "${TEST_KEY_DIR}/id_ecdsa"
