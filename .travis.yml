---
dist: trusty
sudo: false

language: rust
cache: cargo
rust:
  - stable
  # Arbitrary ~recent known-good nightly. Runs benchmarks
  - nightly-2018-05-26

stages:
  - build
  - name: test
    if: rust = stable
  - name: benches
    if: rust =~ /^nightly/
  - name: publish
    if: rust = stable # AND branch = master

jobs:
  include:
    # Build the proxy in release mode so that tests are run against the same
    # binaries that will be used in production.
    #
    # Verbose is enabled so that the build doesn't timeout.
    #
    # The first build command produces a target/release/linkerd2-proxy that may
    # be published later. The second build command compiles tests and does NOT overwrite
    - stage: build
      install: cargo fetch --locked
      script:
        - cargo build --frozen --release --verbose
        - cargo build --frozen --release --verbose --tests --no-default-features

    - stage: test
      script: cargo test --frozen --release --no-default-features

    - stage: benches
      script: cargo test --frozen --release --no-default-features --benches

    - stage: publish
      if: rust = nightly-2018-05-26
      script: shasum -a 256 target/release/linked2-proxy


# Don't test pushes to branches, since they are redundant with the
# pull_request build for each branch.
branches:
  only:
    - master

notifications:
  email:
    on_success: never
