---
dist: trusty
sudo: false

language: rust
cache: cargo
rust:
  - stable
  - nightly-2018-05-26  # Arbitrary ~recent known-good nightly

stages:
  - build
  - test

jobs:
  include:
    - stage: build
      install: cargo fetch --locked
      # Verbose is enabled so that the build doesn't timeout.
      script:
        - cargo build --release --frozen --no-default-features --verbose
        - cargo build --release --frozen --no-default-features --verbose --tests

    - stage: test
      if: rust = stable
      script: cargo test --release --frozen --no-default-features

    - if: rust != stable
      script: cargo test --benches --frozen --no-default-features

notifications:
  email:
    on_success: never

# Don't test pushes to branches, since they are redundant with the
# pull_request build for each branch.
branches:
  only:
    - master
