---
dist: trusty
sudo: false

language: rust
cache: cargo

stages:
  - test
  - name: publish
    #if: branch = master AND type != pull_request

jobs:
  include:

    # Verbose is enabled so that the build doesn't timeout.
    - rust: stable
      stage: test
      script:
        - cargo fetch --locked
        - cargo build --frozen --no-default-features --tests --verbose
        - cargo test  --frozen --no-default-features

    - stage: publish
      cache: cargo
      script:
        - cargo build --frozen --release --verbose
        - ls -l target/release/linkerd2-proxy && shasum -a 256 target/release/linkerd2-proxy

    - rust: nightly-2018-05-26
      cache: cargo
      stage: test
      script:
        - cargo fetch --locked
        - cargo build --frozen --no-default-features --benches --verbose
        - cargo test  --frozen --no-default-features --benches

notifications:
  email:
    on_success: never

# Only build pull requests and master.
branches:
  only:
    - master
