apiVersion: policy.linkerd.io/v1beta1
kind: HTTPRoute
metadata:
  name: listener-routing
  namespace: custom-test # APPLY THIS IN THE CLIENT'S NAMESPACE
spec:
  parentRefs:
    - name: listener-svc # Must match the Service name used by the client app
      kind: Service
      port: 80
      group: core
  hostnames:
    - "listener-svc.custom-test.svc.cluster.local"
  
  rules:
  # ----------------------------------------------------
  # Rule 1: NFR-Enabled Traffic (Priority Rule)
  # ----------------------------------------------------
  - matches:
    - headers:
      - name: myntra-nfr-test # Match the header added by the Linkerd proxy
        value: "TRUE"    # Match the specific value
        type: Exact
    
    # Send traffic matching this rule to the NFR service
    backendRefs:
    - name: listener-svc # The name of the actual destination service
      namespace: nfr-test # The namespace where nfr-listener-svc runs
      port: 80
      
  # ----------------------------------------------------
  # Rule 2: Default Traffic (Fallback Rule)
  # ----------------------------------------------------
  - backendRefs:
    - name: listener-svc # The name of the standard destination service
      namespace: custom-test # The namespace where listener-svc runs
      port: 80
