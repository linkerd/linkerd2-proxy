# emitter.yaml - MANUAL INCLUSION (No Injection Webhook Used)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: emitter
  namespace: custom-test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: emitter
  template:
    metadata:
      annotations:
        # 1. CRITICAL: Remove the injection annotation to disable the webhook
        # REMOVE: linkerd.io/inject: enabled
        
        # 2. Add custom environment variable directly to the pod template
        # The injector won't filter this, as it's defined directly in the YAML
        config.linkerd.io/proxy-env-MYNTRA_NFR_TEST_ENABLED: "true"
        
        # Add the annotation to skip the identity check, addressing the crash
        config.linkerd.io/disable-identity: "true" 
        
      labels:
        app: emitter
    spec:
      # Use the imagePullPolicy from your custom configuration
      imagePullSecrets: []
      
      # -------------------------------------------------------------------
      # 1. INIT CONTAINERS (Mandatory: Sets up iptables forwarding)
      # -------------------------------------------------------------------
      initContainers:
      - name: linkerd-init
        image: cr.l5d.io/linkerd/proxy-init:v2.4.3 # Use the official Init image
        imagePullPolicy: IfNotPresent
        securityContext:
          capabilities:
            add: ["NET_ADMIN", "NET_RAW"]
          runAsUser: 0
        args:
        - --firewall-bin-path
        - iptables-nft
        - --firewall-save-bin-path
        - iptables-nft-save
        - --ipv6=false
        - --incoming-proxy-port=4143
        - --outgoing-proxy-port=4140
        - --proxy-uid=2102
        - --inbound-ports-to-ignore=4190,4191,4567,4568
        - --outbound-ports-to-ignore=4567,4568
        volumeMounts:
        - mountPath: /run
          name: linkerd-proxy-init-xtables-lock
        - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
          name: kube-api-access-dh96p # Use the actual projected volume name from your describe output
          readOnly: true
          
      # -------------------------------------------------------------------
      # 2. APPLICATION AND PROXY CONTAINERS
      # -------------------------------------------------------------------
      containers:
      # A. Linkerd Proxy Container (Your Custom Binary)
      - name: linkerd-proxy
        image: 10.12.0.106:5000/linkerd-proxy:myntra1.0 # YOUR CUSTOM IMAGE
        imagePullPolicy: Always
        ports:
        - containerPort: 4143
          name: linkerd-proxy
        - containerPort: 4191
          name: linkerd-admin
        # CRITICAL: Manually inject environment variables
        env:
        - name: LINKERD2_PROXY_LOG
          value: "warn,linkerd=debug"
        - name: LINKERD2_PROXY_ADMIN_LISTEN_ADDR
          value: "0.0.0.0:4191"
        - name: LINKERD2_PROXY_INBOUND_LISTEN_ADDR
          value: "0.0.0.0:4143"
        - name: LINKERD2_PROXY_OUTBOUND_LISTEN_ADDR
          value: "127.0.0.1:4140"
        - name: LINKERD2_PROXY_IDENTITY_DISABLED # Explicitly disable identity if you don't need mTLS
          value: "true"
        # YOUR CUSTOM ENVIRONMENT VARIABLE GOES HERE
        - name: LINKERD2_PROXY_MYNTRA_NFR_TEST_ENABLED
          value: "true"

        # Copy the required mTLS volumes to avoid configuration errors
        volumeMounts:
        - mountPath: /var/run/linkerd/identity/end-entity
          name: linkerd-identity-end-entity
        - mountPath: /var/run/secrets/tokens
          name: linkerd-identity-token
        - mountPath: /var/run/secrets/kubernetes.io/serviceaccount
          name: kube-api-access-dh96p
          readOnly: true

      # B. Emitter App Container (Your application)
      - name: emitter-app
        image: curlimages/curl:latest
        command: ["sleep", "3600"]
        
      # -------------------------------------------------------------------
      # 3. VOLUMES (Copied from the Pod Description)
      # -------------------------------------------------------------------
      volumes:
      - name: kube-api-access-dh96p
        projected:
          sources:
          - serviceAccountToken:
              expirationSeconds: 3607
              path: token
          - configMap:
              items:
              - key: ca.crt
                path: ca.crt
              name: kube-root-ca.crt
          - downwardAPI:
              items:
              - fieldRef:
                  apiVersion: v1
                  fieldPath: metadata.namespace
                path: namespace
      - name: linkerd-proxy-init-xtables-lock
        emptyDir: {}
      - name: linkerd-identity-end-entity
        emptyDir:
          medium: Memory
      - name: linkerd-identity-token
        projected:
          sources:
          - serviceAccountToken:
              expirationSeconds: 86400
              path: linkerd-identity-token
